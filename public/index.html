<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Animaci√≥n suave al pasar el mouse sobre los productos */
        li { transition: all 0.3s ease; }
        li:hover {
            transform: translateX(5px);
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gradient-to-r from-cyan-500 to-blue-500 min-h-screen flex items-center justify-center font-sans py-10">

    <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
        <h1 class="text-3xl font-bold text-slate-800 mb-6 text-center">üì¶ Inventario V2</h1>

        <div class="mb-6 bg-slate-50 p-5 rounded-lg border border-slate-200 shadow-inner">
            <h2 class="text-xs font-bold text-slate-500 mb-3 uppercase tracking-wide">Gestionar Producto</h2>
            <div class="space-y-3">
                <input id="inputNombre" type="text" placeholder="Nombre (Ej. Laptop)" required
                    class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500 transition">
                
                <input id="inputPrecio" type="number" placeholder="Precio (Ej. 150.00)" min="0.01" step="0.01"
                    class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500 transition">
                
                <button id="btnAccion" onclick="gestionarProducto()" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded shadow transition transform active:scale-95">
                    Guardar Producto
                </button>
            </div>
        </div>

        <div class="flex gap-2 mb-4">
            <div class="relative flex-1">
                <input 
                    id="inputBusqueda" 
                    type="text" 
                    placeholder="üîç Buscar..." 
                    oninput="cargarProductos(true)"
                    class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-slate-50 text-sm"
                >
            </div>
            
            <div class="w-1/3">
                <select id="selectOrden" onchange="cargarProductos(true)" 
                    class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 bg-slate-50 text-sm h-full">
                    <option value="defecto">üìÖ Normal</option>
                    <option value="az">üî§ A - Z</option>
                    <option value="za">üî§ Z - A</option>
                    <option value="precio_menor">üí≤ Baratos</option>
                    <option value="precio_mayor">üí≤ Caros</option>
                </select>
            </div>
        </div>

        <div class="flex justify-between items-end border-b pb-2 mb-3">
            <h2 class="text-lg font-bold text-slate-700">Productos</h2>
            <span id="totalLabel" class="text-xs text-gray-500">Cargando...</span>
        </div>
        
        <ul id="listaProductos" class="space-y-3 min-h-[300px]">
            <p class="text-center text-gray-400 py-10">Iniciando sistema...</p>
        </ul>

        <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
            <button id="btnPrev" onclick="cambiarPagina(-1)" 
                class="bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-2 px-4 rounded disabled:opacity-40 disabled:cursor-not-allowed transition">
                ‚¨ÖÔ∏è
            </button>
            
            <span id="indicadorPagina" class="text-sm font-medium text-slate-600">
                Pg 1
            </span>

            <button id="btnNext" onclick="cambiarPagina(1)" 
                class="bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-2 px-4 rounded disabled:opacity-40 disabled:cursor-not-allowed transition">
                ‚û°Ô∏è
            </button>
        </div>
    </div>

    <script>
        const API_URL = '/api/productos';
        let idEditando = null;
        let paginaActual = 1;

        // --- 1. CARGAR PRODUCTOS (GET) ---
        async function cargarProductos(resetearPagina = false) {
            if (resetearPagina) paginaActual = 1;

            const termino = document.getElementById('inputBusqueda').value;
            const orden = document.getElementById('selectOrden').value;

            // Construimos la URL con todos los par√°metros
            let url = `${API_URL}?pagina=${paginaActual}&orden=${orden}`;
            if (termino) url += `&busqueda=${encodeURIComponent(termino)}`;

            try {
                const respuesta = await fetch(url);
                const resultado = await respuesta.json(); 
                
                const lista = document.getElementById('listaProductos');
                lista.innerHTML = '';

                // Actualizar info de paginaci√≥n
                document.getElementById('indicadorPagina').innerText = `P√°gina ${resultado.paginaActual} de ${resultado.totalPaginas || 1}`;
                document.getElementById('totalLabel').innerText = `${resultado.totalProductos} registros`;
                document.getElementById('btnPrev').disabled = (resultado.paginaActual === 1);
                document.getElementById('btnNext').disabled = (resultado.paginaActual >= resultado.totalPaginas);

                // Caso lista vac√≠a
                if (resultado.datos.length === 0) {
                    lista.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-40 text-gray-400">
                            <span class="text-2xl mb-2">ü§∑‚Äç‚ôÇÔ∏è</span>
                            <p>No hay resultados</p>
                        </div>`;
                    return;
                }

                // Renderizar lista
                resultado.datos.forEach(producto => {
                    const item = `
                        <li class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-lg shadow-sm hover:shadow-md">
                            <div class="flex-1">
                                <div class="font-bold text-slate-700">${producto.nombre}</div>
                                <div class="text-green-600 font-bold text-sm">$${producto.precio}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="llenarFormulario('${producto.nombre}', '${producto.precio}', ${producto.id})" 
                                    class="bg-yellow-400 hover:bg-yellow-500 text-white p-2 rounded shadow-sm" title="Editar">‚úèÔ∏è</button>
                                <button onclick="eliminarProducto(${producto.id})" 
                                    class="bg-red-500 hover:bg-red-600 text-white p-2 rounded shadow-sm" title="Eliminar">üóëÔ∏è</button>
                            </div>
                        </li>`;
                    lista.innerHTML += item;
                });
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('listaProductos').innerHTML = '<p class="text-red-500 text-center py-4">Error al conectar con el servidor</p>';
            }
        }

        // --- 2. CAMBIAR DE P√ÅGINA ---
        function cambiarPagina(dir) {
            paginaActual += dir;
            cargarProductos();
        }

        // --- 3. GUARDAR / ACTUALIZAR (POST / PUT) ---
        async function gestionarProducto() {
            const nombre = document.getElementById('inputNombre').value;
            const precio = document.getElementById('inputPrecio').value;

            // VALIDACI√ìN FRONTEND (Primer Escudo)
            if (!nombre.trim()) return alert("El nombre es obligatorio");
            if (!precio || parseFloat(precio) <= 0) return alert("El precio debe ser mayor a 0");

            try {
                const method = idEditando === null ? 'POST' : 'PUT';
                const url = idEditando === null ? API_URL : `${API_URL}/${idEditando}`;

                const respuesta = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, precio })
                });

                // MANEJO DE ERRORES DEL BACKEND (Segundo Escudo)
                if (!respuesta.ok) {
                    const errorData = await respuesta.json();
                    throw new Error(errorData.error || "Error desconocido en el servidor");
                }

                // √âXITO: Limpiar todo
                idEditando = null;
                const btn = document.getElementById('btnAccion');
                btn.innerText = "Guardar Producto";
                btn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded shadow transition transform active:scale-95";
                
                document.getElementById('inputNombre').value = '';
                document.getElementById('inputPrecio').value = '';
                
                cargarProductos(); // Recargar lista

            } catch (error) {
                alert("‚ö†Ô∏è Error: " + error.message);
            }
        }

        // --- 4. PREPARAR FORMULARIO (Editar) ---
        function llenarFormulario(n, p, id) {
            document.getElementById('inputNombre').value = n;
            document.getElementById('inputPrecio').value = p;
            idEditando = id;
            
            // Cambiar bot√≥n a modo "Actualizar" (Verde)
            const btn = document.getElementById('btnAccion');
            btn.innerText = "Actualizar Producto";
            btn.className = "w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded shadow transition transform active:scale-95";
        }

        // --- 5. ELIMINAR (DELETE) ---
        async function eliminarProducto(id) {
            if(!confirm('¬øEst√°s seguro de borrar este producto?')) return;
            
            try {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                cargarProductos();
            } catch (error) {
                alert("No se pudo eliminar");
            }
        }

        // Iniciar app
        cargarProductos();
    </script>
</body>
</html>